dsl_version: 0.1.0
service:
  name: nova-libvirt
  kind: DaemonSet
  hostNetwork: true
  hostPID: true
  containers:
    - name: nova-libvirt
      image: nova-libvirt
      privileged: true
      volumes:
        - name: run
          type: host
          path: /run
        - name: modules
          type: host
          path: /lib/modules
        - name: nova
          type: host
          path: /var/lib/nova
        - name: libvirt-lib
          type: host
          path: /var/lib/libvirt
        - name: libvirt-conf
          type: host
          path: /etc/libvirt/qemu
        - name: cgroup
          type: host
          path: /sys/fs/cgroup
        # {% if nova.sriov.enabled %}
        - name: dev
          type: host
          path: /dev
        # {% endif %}
        # {% if nova.libvirt.hugepages %}
        - name: hugepages
          type: host
          path: /dev/hugepages
        # {% endif %}
      pre:
        - name: nova-libvirt-bootstrap
          command: /tmp/nova-libvirt-bootstrap.sh
      daemon:
        command: libvirtd --listen
        dependencies:
          - nova-db-migrations
        files:
          - libvirtd.conf
          - nova-libvirt-bootstrap.sh
          # {% if nova.libvirt.tls.enabled %}
          - libvirt-cacert
          - libvirt-servercert
          - libvirt-serverkey
          - libvirt-clientcert
          - libvirt-clientkey
          # {% endif %}
          - qemu.conf
          # {% if nova.ceph.enable %}
          - rbd-secret
          - ceph-conf
          - nova-ceph-key
          - ceph-libvirt-secret-config.sh
      post:
        - name: nova-libvirt-secret-set
          command: /opt/ccp/bin/ceph-libvirt-secret-config.sh
          # {% endif %}
    - name: nova-virtlogd
      image: nova-libvirt
      privileged: true
      volumes:
        - name: run
          type: host
          path: /run
        - name: modules
          type: host
          path: /lib/modules
        - name: nova
          type: host
          path: /var/lib/nova
        - name: libvirt-lib
          type: host
          path: /var/lib/libvirt
        - name: libvirt-conf
          type: host
          path: /etc/libvirt/qemu
        - name: cgroup
          type: host
          path: /sys/fs/cgroup
      daemon:
        command: virtlogd -f /etc/libvirt/virtlogd.conf

files:
  libvirtd.conf:
    path: /etc/libvirt/libvirtd.conf
    content: libvirtd.conf.j2
    perm: "0600"
  nova-libvirt-bootstrap.sh:
    path: /tmp/nova-libvirt-bootstrap.sh
    content: nova-libvirt-bootstrap.sh
    perm: "0755"
  # {% if nova.libvirt.tls.enabled %}
  libvirt-cacert:
    path: /etc/pki/CA/cacert.pem
    content: libvirt.cacert.j2
    perm: "0444"
  libvirt-servercert:
    path: /etc/pki/libvirt/servercert.pem
    content: libvirt.servercert.j2
    perm: "0440"
  libvirt-serverkey:
    path: /etc/pki/libvirt/private/serverkey.pem
    content: libvirt.serverkey.j2
    perm: "0440"
  libvirt-clientcert:
    path: /etc/pki/libvirt/clientcert.pem
    content: libvirt.clientcert.j2
    perm: "0400"
  libvirt-clientkey:
    path: /etc/pki/libvirt/private/clientkey.pem
    content: libvirt.clientkey.j2
    perm: "0400"
  # {% endif %}
  qemu.conf:
    path: /etc/libvirt/qemu.conf
    content: qemu.conf.j2
    perm: "0600"
  rbd-secret:
    path: /etc/libvirt/secrets/secret.xml
    content: rbd_secret.xml.j2
    perm: "0600"
  ceph-conf:
    path: /etc/ceph/ceph.conf
    content: ceph.conf.j2
  nova-ceph-key:
    path: /etc/ceph/ceph.client.cinder.keyring
    content: ceph.client.cinder.keyring.j2
  ceph-libvirt-secret-config.sh:
    path: /opt/ccp/bin/ceph-libvirt-secret-config.sh
    content: ceph-libvirt-secret-config.sh.j2
    perm: "0755"
