dsl_version: 0.1.0
service:
  name: nova-compute
  kind: DaemonSet
  hostNetwork: true
  containers:
    - name: nova-compute
      image: nova-compute
      privileged: true
      volumes:
        - name: run
          type: host
          path: /run
        - name: modules
          type: host
          path: /lib/modules
        - name: nova
          type: host
          path: /var/lib/nova
        - name: libvirt
          type: host
          path: /var/lib/libvirt
      pre:
        - name: disable-netfilter-4
          command: "echo sudo sysctl net.bridge.bridge-nf-call-iptables=1"
        - name: disable-netfilter-6
          command: "echo sudo sysctl net.bridge.bridge-nf-call-ip6tables=1"
        - name: create-dir
          command: "sudo /bin/chown -R nova: /var/lib/nova ; mkdir -p /var/lib/nova/instances"
      daemon:
        command: nova-compute --config-file /etc/nova/nova.conf
        dependencies:
          - nova-db-migrations
          - nova-libvirt:local
          - nova-conductor
          - "{{ messaging.dependencies[messaging.backend.rpc] }}"
          - "{{ messaging.dependencies[messaging.backend.notifications] }}"
        files:
          - nova.conf
          # {% if nova.libvirt.tls.enabled %}
          - libvirt-cacert
          # {% endif %}
          # {% if nova.ceph.enable %}
          - ceph-conf
          - nova-ceph-key
          # {% endif %}

files:
  nova.conf:
    path: /etc/nova/nova.conf
    content: nova.conf.j2
    perm: "0600"
  # {% if nova.libvirt.tls.enabled %}
  libvirt-cacert:
    path: /etc/pki/CA/cacert.pem
    content: libvirt.cacert.j2
    perm: "0444"
  # {% endif %}
  # {% if nova.ceph.enable %}
  ceph-conf:
    path: /etc/ceph/ceph.conf
    content: ceph.conf.j2
  nova-ceph-key:
    path: /etc/ceph/ceph.client.{{ cinder.ceph.username }}.keyring
    content: ceph.client.cinder.keyring.j2
  # {% endif %}
