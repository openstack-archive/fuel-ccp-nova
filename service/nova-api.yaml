service:
  name: nova-api
  ports:
    - {{ nova_api_port }}
    - {{ nova_metadata_port }}
  containers:
    - name: nova-api
      image: nova-api
      privileged: true
      probes:
        readiness: "true"
        liveness: "true"
      pre:
        - name: nova-db-create
          type: single
          command: mysql -v -u root -p{{ db_root_password }} -h mariadb -e 'create database `{{ nova_db_name }}`;
                   create database `{{ nova_api_db_name }}`;
                   grant all privileges on `{{ nova_db_name }}`.* to "{{ nova_db_username }}"@"%" identified by "{{ nova_db_password }}";
                   grant all privileges on `{{ nova_api_db_name }}`.* to "{{ nova_db_username }}"@"%" identified by "{{ nova_db_password }}"'
          dependencies:
            - mariadb
          files:
            - nova.conf
        - name: nova-db-sync
          type: single
          command: nova-manage db sync
          dependencies:
            - nova-db-create
          files:
            - nova.conf
        - name: nova-api-db-sync
          type: single
          command: nova-manage api_db sync
          dependencies:
            - nova-db-sync
          files:
            - nova.conf
        - name: nova-db-migrations
          type: single
          command: nova-manage db online_data_migrations
          dependencies:
            - nova-api-db-sync
          files:
            - nova.conf
        - name: nova-user-create
          type: single
          command: openstack user create --project service --password {{ nova_db_password }} {{ nova_db_username }}
          dependencies:
            - keystone-create-project
        - name: nova-role-add
          dependencies:
            - nova-user-create
          type: single
          command: openstack role add --project service --user {{ nova_db_username }} admin
        - name: nova-service-create
          dependencies:
            - keystone
          type: single
          command: openstack service create --name nova --description "OpenStack Compute" compute
        - name: nova-public-endpoint-create
          dependencies:
            - nova-service-create
          type: single
          command: openstack endpoint create --region RegionOne compute public http://nova-api.{{ namespace }}:{{ nova_api_port }}/v2/%\(tenant_id\)s
        - name: nova-internal-endpoint-create
          dependencies:
            - nova-service-create
          type: single
          command: openstack endpoint create --region RegionOne compute internal http://nova-api.{{ namespace }}:{{ nova_api_port }}/v2/%\(tenant_id\)s
        - name: nova-admin-endpoint-create
          dependencies:
            - nova-service-create
          type: single
          command: openstack endpoint create --region RegionOne compute admin http://nova-api.{{ namespace }}:{{ nova_api_port }}/v2/%\(tenant_id\)s
      daemon:
        command: nova-api --config-file /etc/nova/nova.conf
        files:
          - nova.conf
files:
  nova.conf:
    path: /etc/nova/nova.conf
    content: nova.conf.j2
    perm: "0600"
