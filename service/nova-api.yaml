service:
  name: nova-api
  ports:
    - nova_api_port
    - nova_metadata_port
  containers:
    - name: nova-api
      image: nova-api
      privileged: true
      probes:
        readiness: "true"
        liveness: "true"
      pre:
        - name: nova-db-creation
          type: single
          command: /tmp/nova-api-db-create.sh
          dependencies:
            - mariadb
            - keystone-create-project
          files:
            - nova-api-db-create.sh
            - nova.conf

        - name: nova-db-sync
          type: single
          command: nova-manage db sync
          dependencies:
            - nova-db-creation
          files:
            - nova.conf

        - name: nova-api-db-sync
          type: single
          command: nova-manage api_db sync
          dependencies:
            - nova-db-sync
          files:
            - nova.conf

        - name: nova-db-migrations
          type: single
          command: nova-manage db online_data_migrations
          dependencies:
            - nova-api-db-sync
          files:
            - nova.conf

      daemon:
        command: nova-api --config-file /etc/nova/nova.conf
        files:
          - nova.conf
files:
  nova.conf:
    path: /etc/nova/nova.conf
    content: nova.conf.j2
    perm: "0600"
  nova-api-db-create.sh:
    path: /tmp/nova-api-db-create.sh
    content: nova-api-db-create.sh.j2
    perm: "0755"
